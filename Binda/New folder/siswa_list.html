<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binda - Data Siswa</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-blue: #0d6efd;
            --bg-light: #f4f6f9;
            --text-grey: #6c757d;
            --sidebar-width: 240px;
            --panel-width: 320px; /* Lebar panel kanan */
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-light);
            font-size: 0.85rem;
            color: #333;
            overflow-x: hidden;
        }

        /* --- LAYOUT UTAMA --- */
        .top-header {
            background: white;
            height: 60px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.05);
            position: fixed;
            top: 0; left: 0; right: 0; z-index: 1000;
        }

        .sidebar {
            width: var(--sidebar-width);
            background: white;
            position: fixed;
            top: 60px; bottom: 0; left: 0;
            padding-top: 15px;
            overflow-y: auto;
            border-right: 1px solid #e9ecef;
            z-index: 900;
        }
        .nav-link {
            color: var(--text-grey); padding: 12px 20px; display: flex; align-items: center; gap: 15px;
            text-decoration: none; font-weight: 500; transition: 0.2s;
        }
        .nav-link:hover, .nav-link.active { color: var(--primary-blue); background: #eef4ff; }
        .submenu { display: none; background: white; }
        .submenu.show { display: block; }

        .main-wrapper {
            margin-left: var(--sidebar-width);
            margin-top: 60px;
            min-height: calc(100vh - 60px);
            display: flex; flex-direction: column;
        }

        /* --- CONTROL PANEL --- */
        .control-panel {
            background: white; padding: 8px 25px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #e9ecef;
        }
        .realtime-search input {
            width: 250px; padding: 6px 15px 6px 35px; border-radius: 20px;
            border: 1px solid #ddd; background: #f8f9fa; outline: none;
        }
        .realtime-search i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #aaa; }

        /* --- CONTENT BODY --- */
        .content-body {
            padding: 20px;
            display: flex;
            flex-grow: 1;
            gap: 20px;
            overflow: hidden;
            position: relative;
        }

        .data-area {
            flex-grow: 1;
            background: white; border-radius: 8px; padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
            overflow-x: auto; transition: 0.3s;
        }

        /* --- PANEL KANAN (PREVIEW) --- */
        .right-panel {
            width: var(--panel-width);
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px; /* Lebih rounded */
            padding: 40px 20px 20px 20px;
            /* Update Style: Geser sedikit ke kiri (margin-right) & shadow lebih halus */
            margin-right: 10px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            
            display: flex; flex-direction: column; align-items: center;
            flex-shrink: 0;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            transform: translateX(0);
        }

        /* State Tersembunyi */
        .right-panel.hidden {
            width: 0; padding: 0; margin: 0; border: none; opacity: 0; transform: translateX(50px);
        }

        /* --- TOMBOL TOGGLE (EXPAND/COLLAPSE) --- */
        .toggle-btn-wrapper {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 10;
        }
        
        /* Update Tombol Mengambang (FAB Style) */
        .floating-expand-btn {
            position: absolute; /* Relative terhadap content-body */
            top: 20px;
            right: 20px; /* Posisi di pojok kanan area konten */
            background: var(--primary-blue);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%; /* Bulat penuh */
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(13, 110, 253, 0.3);
            z-index: 999;
            transition: 0.3s;
            display: none; /* Default hidden */
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }
        .floating-expand-btn:hover { 
            background: #0b5ed7; 
            transform: scale(1.1);
        }

        /* --- RASIO FOTO 4:6 --- */
        .photo-frame {
            width: 100%;
            max-width: 180px; /* Lebar maksimal */
            aspect-ratio: 2 / 3; /* Rasio 4:6 */
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 5px;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .photo-frame img {
            width: 100%;
            height: 100%;
            object-fit: cover; 
        }
        .photo-placeholder {
            color: #adb5bd;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* --- COMPONENTS --- */
        .box-tab { border: 1px solid #ddd; padding: 5px 20px; border-radius: 4px; cursor: pointer; color: var(--primary-blue); background: white; margin-right:5px;}
        .box-tab.active { background: var(--primary-blue); color: white; border-color: var(--primary-blue); }
        
        .table-custom tbody tr:hover { background-color: #f8f9fa; transform: translateY(-1px); }
        .table-custom tr.selected { background: var(--primary-blue) !important; color: white; }
        .table-custom tr.selected td { border-color: var(--primary-blue); }
        .table-custom tr.selected .text-muted { color: #eef4ff !important; }

        .student-card { border: 1px solid #eee; padding: 15px; text-align: center; border-radius: 8px; cursor: pointer; background: white; }
        .student-card:hover { border-color: var(--primary-blue); }
        .student-card img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #f8f9fa; margin-bottom: 10px; }
        
        .grid-container { display: none; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        
        /* Utility */
        .btn-custom { padding: 5px 12px; border-radius: 4px; border: none; font-size: 0.8rem; color: white; text-decoration: none; display: inline-flex; align-items: center; gap: 5px;}
        .btn-grey { background: #6c757d; } .btn-green { background: #198754; } .btn-red { background: #dc3545; } .btn-blue { background: #0d6efd; }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header class="top-header">
        <div class="brand-logo me-4">
            <img src="{{ url_for('static', filename='img/logo_app.png') }}" height="30" alt="Binda">
        </div>
        <div class="header-center">
            <div id="jam" style="font-weight: 600;">00.00.00</div>
            <div id="tanggal" style="font-size: 0.7rem; color: #888;">...</div>
        </div>
        <div class="header-right d-flex align-items-center">
            <div class="text-end me-3">
                <h6 class="m-0 fw-bold" style="font-size: 0.9rem;">SMK DARUL ABROR</h6>
                <small class="text-primary" style="font-size: 0.7rem;">masuk sebagai admin</small>
            </div>
            <img src="{{ url_for('static', filename='img/logo_sekolah.png') }}" height="35" alt="Sekolah">
        </div>
    </header>

    <!-- SIDEBAR -->
    <nav class="sidebar">
        <ul style="padding:0; list-style:none;">
            <li><a href="#" class="nav-link"><i class="fas fa-th-large icon-left" style="width:20px;text-align:center;"></i> Beranda</a></li>
            <li>
                <a href="#" class="nav-link active" onclick="toggleSubmenu('menuSiswa', this)">
                    <i class="fas fa-user-graduate icon-left" style="width:20px;text-align:center;"></i> Siswa 
                    <i class="fas fa-chevron-down ms-auto" style="font-size:0.7rem;"></i>
                </a>
                <ul id="menuSiswa" class="submenu show">
                    <li>
                        <a href="#" class="nav-link" style="color:var(--primary-blue); font-weight:600; padding-left:55px; height:35px;">Aktif</a>
                        <div style="padding-left: 75px;">
                            <a href="#" style="display:block; padding:3px 0; color:#444; text-decoration:none; font-size:0.8rem">• DKV</a>
                            <a href="#" style="display:block; padding:3px 0; color:#888; text-decoration:none; font-size:0.8rem">• TKJ</a>
                        </div>
                    </li>
                    <li><a href="#" class="nav-link" style="padding-left:55px; height:35px;">Lulus</a></li>
                    <li><a href="#" class="nav-link" style="padding-left:55px; height:35px;">Keluar</a></li>
                </ul>
            </li>
            <li><a href="#" class="nav-link"><i class="fas fa-chalkboard-teacher icon-left" style="width:20px;text-align:center;"></i> Guru/Karyawan</a></li>
            <li><a href="#" class="nav-link"><i class="fas fa-calendar-alt icon-left" style="width:20px;text-align:center;"></i> Kaldik</a></li>
            <li><a href="#" class="nav-link"><i class="fas fa-cog icon-left" style="width:20px;text-align:center;"></i> Pengaturan</a></li>
            <li><a href="#" class="nav-link text-danger mt-4"><i class="fas fa-power-off icon-left" style="width:20px;text-align:center;"></i> Keluar</a></li>
        </ul>
    </nav>

    <!-- MAIN CONTENT -->
    <div class="main-wrapper">
        <div class="control-panel">
            <div style="font-size:0.85rem; color:#888;">
                <a href="#" style="text-decoration:none; color:#888;">Buku Induk</a> / 
                <a href="#" style="text-decoration:none; color:#888;">Siswa</a> / 
                <a href="#" style="text-decoration:none; color:#888;">Aktif</a> / 
                <a href="#" style="text-decoration:none; color:#888;">DKV</a> / 
                <span style="color:var(--primary-blue); font-weight:600;">Kelas X</span>
            </div>
            <div class="realtime-search" style="position:relative;">
                <i class="fas fa-search" style="position:absolute; left:12px; top:50%; transform:translateY(-50%); color:#aaa;"></i>
                <input type="text" id="searchInput" placeholder="Cari NIS, Nama..." onkeyup="searchFunction()">
            </div>
        </div>

        <div class="content-body">
            
            <!-- TOMBOL EXPAND MENGAMBANG (Dalam content-body agar posisi relatif thd konten) -->
            <div id="btnExpand" class="floating-expand-btn" onclick="togglePanel()" title="Tampilkan Panel">
                <i class="fas fa-chevron-left"></i>
            </div>

            <!-- DATA AREA -->
            <div class="data-area">
                <div style="display:flex; margin-bottom:20px;">
                    <div class="box-tab">Semua</div>
                    <div class="box-tab active">Kelas X</div>
                    <div class="box-tab">Kelas XI</div>
                    <div class="box-tab">Kelas XII</div>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="d-flex align-items-center gap-3">
                        <select class="form-select form-select-sm border-0 bg-light text-primary fw-bold" style="width: 120px;">
                            <option>X DKV 1</option>
                            <option>X DKV 2</option>
                        </select>
                        <span style="cursor:pointer;" onclick="switchView('list')"><i class="fas fa-list text-primary"></i> Daftar</span>
                        <span style="cursor:pointer; color:#aaa;" onclick="switchView('card')"><i class="fas fa-th-large"></i> Kartu</span>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn-custom btn-grey">Cetak</button>
                        <button class="btn-custom btn-green">Ekspor .xlsx</button>
                        <button class="btn-custom btn-red">Hapus</button>
                        <a href="{{ url_for('siswa_tambah') }}" class="btn-custom btn-blue">+ Tambah</a>
                    </div>
                </div>

                <!-- TABLE LIST -->
                <div id="viewList" class="table-responsive">
                    <table class="table table-hover table-custom" style="font-size:0.85rem;">
                        <thead>
                            <tr style="color:var(--primary-blue);">
                                <th width="3%"><input type="checkbox"></th>
                                <th>NIS</th>
                                <th>Nama Lengkap</th>
                                <th>L/P</th>
                                <th>Tempat Lahir</th>
                                <th>Tanggal Lahir</th>
                                <th>Domisili</th>
                                <th class="text-end">Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for s in siswa %}
                            <tr class="searchable-item" onclick="selectRow(this, {{ s.id }})" 
                                data-name="{{ s.nama_lengkap }}" data-nis="{{ s.nis }}">
                                <td><input type="checkbox" onclick="event.stopPropagation()"></td>
                                <td>{{ s.nis }}</td>
                                <td class="fw-bold">{{ s.nama_lengkap }}</td>
                                <td>{{ s.jenis_kelamin }}</td>
                                <td>{{ s.tempat_lahir }}</td>
                                <td>{{ s.tanggal_lahir }}</td>
                                <td>{{ s.domisili }}</td>
                                <td class="text-end">
                                    <a href="#" class="text-warning mx-1"><i class="far fa-edit"></i></a>
                                    <div class="btn-group dropstart">
                                        <a href="#" class="text-secondary mx-1" data-bs-toggle="dropdown" onclick="event.stopPropagation()"><i class="fas fa-ellipsis-v"></i></a>
                                        <ul class="dropdown-menu shadow border-0">
                                            <li><a class="dropdown-item" href="#">Detail</a></li>
                                            <li><a class="dropdown-item" href="#">Cetak</a></li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- CARD GRID -->
                <div id="viewCard" class="grid-container">
                    {% for s in siswa %}
                    <div class="student-card searchable-item" onclick="selectCard(this, {{ s.id }})" data-name="{{ s.nama_lengkap }}">
                        <img src="{{ url_for('static', filename='uploads/' + (s.foto_masuk if s.foto_masuk else 'none')) }}" 
                             onerror="this.src='{{ url_for('static', filename='img/default_user.png') }}'">
                        <div class="fw-bold text-truncate">{{ s.nama_lengkap }}</div>
                        <div class="small text-muted">{{ s.nis }}</div>
                        <div class="small text-primary mt-1">X DKV 1</div>
                    </div>
                    {% endfor %}
                </div>

                <div class="d-flex justify-content-between mt-4 text-muted small border-top pt-2">
                    <div>L: <b class="text-primary">{{ stats.L }}</b> | P: <b class="text-primary">{{ stats.P }}</b></div>
                    <div>Total: {{ stats.total }} Siswa</div>
                </div>
            </div>

            <!-- RIGHT PANEL (PREVIEW) -->
            <div class="right-panel" id="rightPanel">
                <!-- Tombol Close Panel (Internal) -->
                <div class="toggle-btn-wrapper">
                    <button onclick="togglePanel()" class="btn btn-sm btn-light text-muted" title="Sembunyikan Panel">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>

                <h6 class="fw-bold mb-0 mt-3" id="p_nama">Pilih Siswa</h6>
                <div class="text-primary small mb-4" id="p_nis">...</div>

                <!-- FOTO MASUK (4:6) -->
                <div class="photo-frame">
                    <img id="p_foto" src="{{ url_for('static', filename='img/default_user.png') }}" 
                         onerror="this.src='{{ url_for('static', filename='img/default_user.png') }}'">
                </div>
                <small class="text-end w-100 d-block text-muted mb-4" style="font-size: 0.7rem;">Pasphoto saat masuk <i class="fas fa-external-link-alt"></i></small>

                <!-- FOTO KELUAR (Placeholder 4:6) -->
                <div class="photo-frame photo-placeholder">
                    <i class="fas fa-user fa-3x mb-2"></i>
                    <span style="font-size:0.7rem">Tidak ada foto</span>
                </div>
                <small class="text-end w-100 d-block text-muted" style="font-size: 0.7rem;">Pasphoto saat keluar <i class="fas fa-external-link-alt"></i></small>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Jam Realtime
        setInterval(() => {
            const now = new Date();
            document.getElementById('jam').innerText = now.toLocaleTimeString('en-GB', {hour12: false}).replace(/:/g, '.');
            document.getElementById('tanggal').innerText = now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }, 1000);

        // Toggle Panel
        function togglePanel() {
            const panel = document.getElementById('rightPanel');
            const btnExpand = document.getElementById('btnExpand');
            
            if (panel.classList.contains('hidden')) {
                // MUNCLUKAN PANEL
                panel.classList.remove('hidden');
                btnExpand.style.display = 'none'; // Sembunyikan tombol expand
            } else {
                // SEMBUNYIKAN PANEL
                panel.classList.add('hidden');
                setTimeout(() => {
                    btnExpand.style.display = 'flex'; // Munculkan tombol expand setelah animasi
                }, 300);
            }
        }

        function switchView(view) {
            if(view === 'list') {
                document.getElementById('viewList').style.display = 'block';
                document.getElementById('viewCard').style.display = 'none';
            } else {
                document.getElementById('viewList').style.display = 'none';
                document.getElementById('viewCard').style.display = 'grid';
            }
        }

        function selectRow(row, id) {
            document.querySelectorAll('tr').forEach(r => r.classList.remove('selected'));
            row.classList.add('selected');
            loadPreview(id);
        }

        function selectCard(card, id) {
            document.querySelectorAll('.student-card').forEach(c => c.style.borderColor = '#eee');
            card.style.borderColor = '#0d6efd';
            loadPreview(id);
        }

        function loadPreview(id) {
            const panel = document.getElementById('rightPanel');
            // Jika tersembunyi, buka otomatis
            if(panel.classList.contains('hidden')) togglePanel();

            fetch(`/siswa/detail/${id}`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById('p_nama').innerText = "'" + data.nama + "'";
                    document.getElementById('p_nis').innerText = data.nis;
                    
                    const img = document.getElementById('p_foto');
                    if(data.foto) {
                        img.src = "/static/uploads/" + data.foto;
                    } else {
                        img.src = "{{ url_for('static', filename='img/default_user.png') }}";
                    }
                });
        }

        function searchFunction() {
            let input = document.getElementById('searchInput');
            let filter = input.value.toUpperCase();
            let items = document.getElementsByClassName('searchable-item');

            for (let i = 0; i < items.length; i++) {
                let name = items[i].getAttribute('data-name');
                let nis = items[i].getAttribute('data-nis') || '';
                if (name.toUpperCase().indexOf(filter) > -1 || nis.indexOf(filter) > -1) {
                    items[i].style.display = "";
                } else {
                    items[i].style.display = "none";
                }
            }
        }

        function toggleSubmenu(id, link) {
            const el = document.getElementById(id);
            const icon = link.querySelector('.fa-chevron-down');
            if (el.classList.contains('show')) {
                el.classList.remove('show');
                icon.style.transform = 'rotate(0deg)';
            } else {
                el.classList.add('show');
                icon.style.transform = 'rotate(180deg)';
            }
        }
    </script>
</body>
</html>