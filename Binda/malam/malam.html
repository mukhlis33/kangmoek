<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Langit Malam dengan Komet Tiamat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0b1220;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        .stage {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            background: linear-gradient(180deg, #081021 0%, #0b2b4a 55%, #2a1a3a 100%);
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .hint {
            position: absolute;
            left: 12px;
            bottom: 12px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
            backdrop-filter: blur(6px);
            background: linear-gradient(90deg, rgba(0, 0, 0, 0.25), rgba(255, 255, 255, 0.02));
            padding: 8px 10px;
            border-radius: 8px;
            z-index: 10;
        }

        .controls {
            position: absolute;
            right: 12px;
            bottom: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 10;
        }

        .controls-panel {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            max-height: 500px;
            overflow: hidden;
        }

        .controls-panel.collapsed {
            max-height: 50px;
            padding: 8px;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .panel-header h3 {
            color: white;
            font-size: 14px;
            font-weight: 500;
        }

        .panel-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: opacity 0.3s ease;
        }

        .controls-panel.collapsed .panel-content {
            opacity: 0;
            pointer-events: none;
        }

        .icon-button {
            background: rgba(0, 0, 0, 0.3);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            backdrop-filter: blur(6px);
            font-size: 16px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }

        .icon-button:hover {
            background: rgba(0, 0, 0, 0.5);
            border-color: rgba(255, 255, 255, 0.4);
            transform: scale(1.05);
        }

        .icon-button.active {
            background: rgba(100, 150, 255, 0.3);
            border-color: rgba(100, 150, 255, 0.5);
        }

        .button-row {
            display: flex;
            gap: 8px;
        }

        .button-row .icon-button {
            flex: 1;
        }

        .music-controls {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 10px;
            z-index: 10;
        }

        .music-info {
            position: absolute;
            top: 12px;
            left: 12px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
            backdrop-filter: blur(6px);
            background: linear-gradient(90deg, rgba(0, 0, 0, 0.25), rgba(255, 255, 255, 0.02));
            padding: 8px 10px;
            border-radius: 8px;
            z-index: 10;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .logo-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 5;
            pointer-events: none;
        }

        .logo {
            max-width: 200px;
            max-height: 150px;
            width: auto;
            height: auto;
            filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.5));
            margin-bottom: 15px;
        }

        .school-name {
            font-family: 'Poppins', sans-serif;
            font-weight: bold;
            font-size: 24px;
            color: white;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.7);
            letter-spacing: 1px;
        }

        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 100;
        }

        .icon-button:hover .tooltip {
            opacity: 1;
        }

        .playlist {
            position: absolute;
            top: 50px;
            right: 12px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            padding: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            display: none;
        }

        .playlist.show {
            display: block;
        }

        .playlist-item {
            padding: 8px 12px;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
            font-size: 13px;
        }

        .playlist-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .playlist-item.active {
            background: rgba(100, 150, 255, 0.3);
            color: white;
        }

        @media (max-width: 600px) {
            .controls {
                right: 8px;
                bottom: 8px;
            }
            
            .hint {
                font-size: 11px;
                padding: 6px 8px;
                left: 8px;
                bottom: 8px;
            }
            
            .music-controls {
                top: 8px;
                right: 8px;
            }
            
            .music-info {
                top: 8px;
                left: 8px;
                font-size: 11px;
                padding: 6px 8px;
                max-width: 150px;
            }
            
            .logo {
                max-width: 150px;
            }
            
            .school-name {
                font-size: 18px;
            }
            
            .playlist {
                right: 8px;
                top: 45px;
                max-height: 150px;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="stage" id="stage">
        <canvas id="sky"></canvas>
        
        <div class="logo-container">
            <img src="logosmkda.png" alt="SMK Darul Abror" class="logo" id="schoolLogo">
            <div class="school-name">SMK Darul Abror</div>
        </div>
        
        <div class="hint">Langit malam â€” Komet Tiamat sedang melintas</div>
        <div class="music-info" id="musicInfo">Memuat musik...</div>
        
        <div class="music-controls">
            <div class="icon-button" id="playlistToggle">
                <i class="fas fa-list"></i>
                <div class="tooltip">Daftar Putar</div>
            </div>
            <div class="icon-button" id="playPause">
                <i class="fas fa-play"></i>
                <div class="tooltip">Putar</div>
            </div>
            <div class="icon-button" id="prevTrack">
                <i class="fas fa-step-backward"></i>
                <div class="tooltip">Lagu Sebelumnya</div>
            </div>
            <div class="icon-button" id="nextTrack">
                <i class="fas fa-step-forward"></i>
                <div class="tooltip">Lagu Berikutnya</div>
            </div>
            <div class="icon-button" id="shuffleToggle">
                <i class="fas fa-random"></i>
                <div class="tooltip">Mode Acak</div>
            </div>
        </div>
        
        <div class="playlist" id="playlist">
            <!-- Daftar lagu akan diisi oleh JavaScript -->
        </div>
        
        <div class="controls">
            <div class="controls-panel" id="controlsPanel">
                <div class="panel-header" id="panelToggle">
                    <h3>Kontrol Langit</h3>
                    <i class="fas fa-chevron-down" id="panelIcon"></i>
                </div>
                <div class="panel-content">
                    <div class="button-row">
                        <div class="icon-button" id="moreStars">
                            <i class="fas fa-star"></i>
                            <div class="tooltip">Lebih Banyak Bintang</div>
                        </div>
                        <div class="icon-button" id="lessStars">
                            <i class="far fa-star"></i>
                            <div class="tooltip">Lebih Sedikit Bintang</div>
                        </div>
                    </div>
                    <div class="button-row">
                        <div class="icon-button" id="shootingStar">
                            <i class="fas fa-bolt"></i>
                            <div class="tooltip">Bintang Jatuh</div>
                        </div>
                        <div class="icon-button" id="comet">
                            <i class="fas fa-meteor"></i>
                            <div class="tooltip">Panggil Komet Tiamat</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <audio id="backgroundMusic"></audio>

    <script>
        // Inisialisasi canvas
        const canvas = document.getElementById('sky');
        const stage = document.getElementById('stage');
        const ctx = canvas.getContext('2d');
        
        // Elemen musik
        const backgroundMusic = document.getElementById('backgroundMusic');
        const playPauseBtn = document.getElementById('playPause');
        const prevTrackBtn = document.getElementById('prevTrack');
        const nextTrackBtn = document.getElementById('nextTrack');
        const shuffleToggleBtn = document.getElementById('shuffleToggle');
        const playlistToggleBtn = document.getElementById('playlistToggle');
        const musicInfo = document.getElementById('musicInfo');
        const playlist = document.getElementById('playlist');
        
        // Kontrol langit
        const moreStarsBtn = document.getElementById('moreStars');
        const lessStarsBtn = document.getElementById('lessStars');
        const shootingStarBtn = document.getElementById('shootingStar');
        const cometBtn = document.getElementById('comet');
        const controlsPanel = document.getElementById('controlsPanel');
        const panelToggle = document.getElementById('panelToggle');
        const panelIcon = document.getElementById('panelIcon');
        
        // Setup DPR untuk tampilan retina
        let DPR = window.devicePixelRatio || 1;
        
        function resize() {
            DPR = window.devicePixelRatio || 1;
            canvas.width = Math.floor(stage.clientWidth * DPR);
            canvas.height = Math.floor(stage.clientHeight * DPR);
            canvas.style.width = stage.clientWidth + 'px';
            canvas.style.height = stage.clientHeight + 'px';
            ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
        }
        
        window.addEventListener('resize', resize);
        resize();

        // Utility functions
        function rand(a, b) { return Math.random() * (b - a) + a; }
        function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

        // Bintang-bintang statis
        let stars = [];
        let STAR_COUNT = Math.floor((canvas.width / DPR + canvas.height / DPR) / 3);

        function initializeStars() {
            stars = [];
            for (let i = 0; i < STAR_COUNT; i++) {
                const isBig = Math.random() < 0.08;
                stars.push({
                    x: rand(0, canvas.width / DPR),
                    y: rand(0, canvas.height / DPR),
                    r: isBig ? rand(1.2, 2.6) : rand(0.4, 1.1),
                    baseAlpha: isBig ? rand(0.6, 0.95) : rand(0.3, 0.75),
                    twinkleSpeed: rand(0.003, 0.014),
                    twinklePhase: Math.random() * Math.PI * 2,
                    hue: isBig ? rand(30, 60) : rand(200, 260),
                    twinkleOffset: Math.random() * 1000,
                    isTwinkling: Math.random() < 0.7,
                });
            }
        }

        initializeStars();

        // Bintang jatuh
        const shootingStars = [];
        const SHOOTING_FREQ = 0.006;

        // Komet Tiamat
        const comets = [];
        const COMET_FREQ = 0.0001; // Sangat jarang untuk komet legendaris

        // Fungsi untuk menggambar bulan sabit
        function drawMoon() {
            const w = canvas.width / DPR;
            const h = canvas.height / DPR;
            
            // Posisi bulan di kanan atas
            const cx = w * 0.85;
            const cy = h * 0.15;
            const radius = Math.min(w, h) * 0.08;
            
            ctx.save();
            
            // Glow bulan
            const glowGradient = ctx.createRadialGradient(cx, cy, radius * 0.5, cx, cy, radius * 2.5);
            glowGradient.addColorStop(0, 'rgba(255, 255, 240, 0.4)');
            glowGradient.addColorStop(0.5, 'rgba(255, 255, 240, 0.1)');
            glowGradient.addColorStop(1, 'rgba(255, 255, 240, 0)');
            
            ctx.fillStyle = glowGradient;
            ctx.beginPath();
            ctx.arc(cx, cy, radius * 2.5, 0, Math.PI * 2);
            ctx.fill();
            
            // Bulan sabit
            ctx.fillStyle = 'rgba(255, 255, 240, 0.95)';
            ctx.beginPath();
            ctx.arc(cx, cy, radius, 0, Math.PI * 2);
            ctx.fill();
            
            // Potongan untuk membentuk sabit
            ctx.globalCompositeOperation = 'destination-out';
            ctx.beginPath();
            ctx.arc(cx - radius * 0.6, cy, radius * 0.9, 0, Math.PI * 2);
            ctx.fill();
            
            // Kembalikan composite operation
            ctx.globalCompositeOperation = 'source-over';
            
            // Tekstur bulan
            ctx.fillStyle = 'rgba(200, 200, 180, 0.3)';
            ctx.beginPath();
            ctx.arc(cx + radius * 0.3, cy - radius * 0.2, radius * 0.15, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.beginPath();
            ctx.arc(cx - radius * 0.1, cy + radius * 0.3, radius * 0.1, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.beginPath();
            ctx.arc(cx + radius * 0.2, cy + radius * 0.4, radius * 0.08, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.restore();
        }

        // Fungsi untuk membuat bintang jatuh
        function spawnShootingStar(x = null, y = null) {
            const startX = x !== null ? x : rand(0, canvas.width / DPR * 0.6);
            const startY = y !== null ? y : rand(-20, canvas.height / DPR * 0.3);
            const speed = rand(8, 16);
            const length = rand(150, 280);
            
            const shootingStar = {
                x: startX,
                y: startY,
                vx: speed * 0.9,
                vy: speed * 0.45,
                length,
                life: 0,
                maxLife: rand(70, 140),
                particles: [],
                trail: []
            };
            
            for (let i = 0; i < 12; i++) {
                shootingStar.particles.push({
                    x: startX,
                    y: startY,
                    vx: speed * 0.9 * rand(0.7, 1.1),
                    vy: speed * 0.45 * rand(0.7, 1.1),
                    life: 0,
                    maxLife: rand(25, 50),
                    size: rand(1, 3)
                });
            }
            
            shootingStars.push(shootingStar);
        }

        // Fungsi untuk membuat KOMET TIAMAT dengan ekor legendaris
        function spawnTiamatComet() {
            const startX = rand(-canvas.width / DPR * 0.4, canvas.width / DPR * 0.4);
            const startY = rand(-200, canvas.height / DPR * 0.25);
            const speed = rand(0.2, 0.6); // Sangat lambat untuk ekor legendaris
            const length = rand(1800, 2800); // EKOR LEGENDARIS PANJANG
            
            const comet = {
                x: startX,
                y: startY,
                vx: speed * 1.2,
                vy: speed * 0.65,
                length,
                life: 0,
                maxLife: rand(4000, 7000), // Hidup sangat lama
                size: rand(8, 15),
                rotation: rand(0, Math.PI * 2),
                particles: [],
                trail: [],
                debris: [],
                sparkParticles: [],
                tailEndParticles: [],
                name: "Tiamat"
            };
            
            // Partikel ekor komet - SANGAT BANYAK untuk ekor legendaris
            for (let i = 0; i < 80; i++) {
                comet.particles.push({
                    x: startX,
                    y: startY,
                    vx: speed * 1.2 * rand(0.8, 1.2),
                    vy: speed * 0.65 * rand(0.8, 1.2),
                    life: 0,
                    maxLife: rand(500, 1200),
                    size: rand(1.5, 5),
                    spread: rand(1, 5),
                    color: `hsl(${rand(180, 220)}, 80%, 70%)`
                });
            }
            
            // Pecahan batu komet Tiamat
            for (let i = 0; i < 3; i++) {
                comet.debris.push({
                    x: startX,
                    y: startY,
                    vx: speed * 1.2 * rand(0.5, 1.5),
                    vy: speed * 0.65 * rand(0.5, 1.5),
                    life: 0,
                    maxLife: rand(400, 1000),
                    size: rand(1, 4),
                    rotation: rand(0, Math.PI * 2),
                    rotationSpeed: rand(-0.05, 0.05)
                });
            }
            
            // Percikan kristal es di sepanjang ekor
            for (let i = 0; i < 40; i++) {
                comet.sparkParticles.push({
                    x: startX,
                    y: startY,
                    vx: speed * 1.2 * rand(0.3, 1.7),
                    vy: speed * 0.65 * rand(0.3, 1.7),
                    life: 0,
                    maxLife: rand(80, 200),
                    size: rand(0.5, 3),
                    spread: rand(3, 8),
                    type: pick(['ice', 'crystal', 'spark'])
                });
            }
            
            // PERCAKIAN CAHAYA LEGENDARIS DI UJUNG EKOR TIAMAT
            for (let i = 0; i < 50; i++) {
                comet.tailEndParticles.push({
                    x: startX - length * 0.85,
                    y: startY - length * 0.45,
                    vx: rand(-3, 3),
                    vy: rand(-3, 3),
                    life: 0,
                    maxLife: rand(100, 300),
                    size: rand(3, 8),
                    color: pick(['255,255,255', '200,230,255', '170,200,255', '255,220,180']),
                    type: pick(['spark', 'glow', 'star', 'nebula']),
                    rotation: rand(0, Math.PI * 2),
                    rotationSpeed: rand(-0.15, 0.15),
                    pulseSpeed: rand(0.02, 0.08)
                });
            }
            
            comets.push(comet);
        }

        // Gambar bintang-bintang dengan efek kelipan
        function drawStars(time) {
            for (const s of stars) {
                let alpha;
                
                if (s.isTwinkling) {
                    const tw = (Math.sin(s.twinklePhase + time * s.twinkleSpeed + s.twinkleOffset) + 1) / 2;
                    alpha = s.baseAlpha * (0.4 + tw * 0.6);
                } else {
                    alpha = s.baseAlpha;
                }
                
                if (s.r < 0.8) {
                    ctx.fillStyle = `rgba(255, 255, 255, ${alpha.toFixed(3)})`;
                    ctx.fillRect(s.x, s.y, 1, 1);
                } else {
                    const rad = s.r * 1.6;
                    const g = ctx.createRadialGradient(s.x, s.y, 0, s.x, s.y, rad);
                    g.addColorStop(0, `rgba(255, 255, 255, ${alpha.toFixed(3)})`);
                    g.addColorStop(0.2, `rgba(255, 255, 220, ${(alpha * 0.85).toFixed(3)})`);
                    g.addColorStop(1, `rgba(255, 255, 220, 0)`);
                    ctx.fillStyle = g;
                    ctx.beginPath();
                    ctx.arc(s.x, s.y, rad, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
        }

        // Gambar bintang jatuh dengan ekor panjang
        function drawShootingStars() {
            for (let i = shootingStars.length - 1; i >= 0; i--) {
                const s = shootingStars[i];
                const alpha = 1 - (s.life / s.maxLife);
                
                s.trail.push({ x: s.x, y: s.y, alpha: alpha });
                if (s.trail.length > 15) s.trail.shift();
                
                for (let j = 0; j < s.trail.length; j++) {
                    const point = s.trail[j];
                    const trailAlpha = point.alpha * (j / s.trail.length);
                    const trailWidth = s.length * 0.03 * (j / s.trail.length);
                    
                    const grd = ctx.createLinearGradient(
                        point.x, point.y, 
                        point.x - s.vx * 0.8, point.y - s.vy * 0.8
                    );
                    grd.addColorStop(0, `rgba(255, 255, 255, ${trailAlpha})`);
                    grd.addColorStop(0.3, `rgba(200, 220, 255, ${trailAlpha * 0.7})`);
                    grd.addColorStop(1, `rgba(150, 180, 255, 0)`);
                    
                    ctx.strokeStyle = grd;
                    ctx.lineWidth = trailWidth;
                    ctx.lineCap = 'round';
                    ctx.beginPath();
                    ctx.moveTo(point.x, point.y);
                    ctx.lineTo(point.x - s.vx * 0.8, point.y - s.vy * 0.8);
                    ctx.stroke();
                }
                
                for (let j = s.particles.length - 1; j >= 0; j--) {
                    const part = s.particles[j];
                    const partAlpha = (1 - (part.life / part.maxLife)) * alpha;
                    
                    ctx.fillStyle = `rgba(180, 200, 255, ${partAlpha})`;
                    ctx.beginPath();
                    ctx.arc(part.x, part.y, part.size, 0, Math.PI * 2);
                    ctx.fill();
                    
                    part.x += part.vx;
                    part.y += part.vy;
                    part.life++;
                    
                    if (part.life > part.maxLife) {
                        s.particles.splice(j, 1);
                    }
                }
                
                ctx.fillStyle = `rgba(255, 255, 230, ${alpha})`;
                ctx.beginPath();
                ctx.arc(s.x, s.y, 2 + (1 - alpha) * 2, 0, Math.PI * 2);
                ctx.fill();
                
                s.x += s.vx;
                s.y += s.vy;
                s.life++;
                
                if (s.life % 2 === 0 && s.particles.length < 20) {
                    s.particles.push({
                        x: s.x,
                        y: s.y,
                        vx: s.vx * rand(0.7, 1.1),
                        vy: s.vy * rand(0.7, 1.1),
                        life: 0,
                        maxLife: rand(20, 40),
                        size: rand(0.8, 2)
                    });
                }
                
                if (s.life > s.maxLife || s.x > canvas.width / DPR + 100 || s.y > canvas.height / DPR + 100) {
                    shootingStars.splice(i, 1);
                }
            }
        }

        // Gambar KOMET TIAMAT dengan ekor legendaris
        function drawComets() {
            for (let i = comets.length - 1; i >= 0; i--) {
                const c = comets[i];
                const alpha = 0.95 * (1 - (c.life / c.maxLife));
                
                // Trail LEGENDARIS PANJANG
                c.trail.push({ x: c.x, y: c.y, alpha: alpha });
                if (c.trail.length > 120) c.trail.shift(); // BANYAK SEKALI titik trail
                
                // Hitung posisi ujung ekor
                const tailEndX = c.x - c.vx * 6;
                const tailEndY = c.y - c.vy * 6;
                
                // Gambar trail komet (ekor utama) - LEGENDARIS PANJANG
                for (let j = 0; j < c.trail.length; j++) {
                    const point = c.trail[j];
                    const trailAlpha = point.alpha * (j / c.trail.length) * 0.8;
                    const trailWidth = c.length * 0.008 * (j / c.trail.length);
                    
                    const grd = ctx.createLinearGradient(
                        point.x, point.y, 
                        point.x - c.vx * 6, point.y - c.vy * 6 // EKOR SANGAT PANJANG
                    );
                    grd.addColorStop(0, `rgba(255, 250, 240, ${trailAlpha})`);
                    grd.addColorStop(0.15, `rgba(230, 240, 255, ${trailAlpha * 0.9})`);
                    grd.addColorStop(0.4, `rgba(200, 220, 255, ${trailAlpha * 0.7})`);
                    grd.addColorStop(0.7, `rgba(170, 200, 255, ${trailAlpha * 0.4})`);
                    grd.addColorStop(0.9, `rgba(140, 180, 255, ${trailAlpha * 0.2})`);
                    grd.addColorStop(1, `rgba(110, 160, 255, 0)`);
                    
                    ctx.strokeStyle = grd;
                    ctx.lineWidth = trailWidth;
                    ctx.lineCap = 'round';
                    ctx.beginPath();
                    ctx.moveTo(point.x, point.y);
                    ctx.lineTo(point.x - c.vx * 6, point.y - c.vy * 6);
                    ctx.stroke();
                }
                
                // Gambar partikel ekor komet Tiamat
                for (let j = c.particles.length - 1; j >= 0; j--) {
                    const part = c.particles[j];
                    const partAlpha = (1 - (part.life / part.maxLife)) * alpha;
                    const spreadX = Math.sin(part.life * 0.03) * part.spread;
                    const spreadY = Math.cos(part.life * 0.03) * part.spread;
                    
                    const grd = ctx.createRadialGradient(
                        part.x + spreadX, 
                        part.y + spreadY, 
                        0, 
                        part.x + spreadX, 
                        part.y + spreadY, 
                        part.size
                    );
                    grd.addColorStop(0, `rgba(255, 250, 240, ${partAlpha})`);
                    grd.addColorStop(0.5, `rgba(220, 235, 255, ${partAlpha * 0.6})`);
                    grd.addColorStop(1, `rgba(200, 220, 255, 0)`);
                    
                    ctx.fillStyle = grd;
                    ctx.beginPath();
                    ctx.arc(part.x + spreadX, part.y + spreadY, part.size, 0, Math.PI * 2);
                    ctx.fill();
                    
                    part.x += part.vx;
                    part.y += part.vy;
                    part.life++;
                    
                    if (part.life > part.maxLife) {
                        c.particles.splice(j, 1);
                    }
                }
                
                // Gambar kristal es Tiamat
                for (let j = c.sparkParticles.length - 1; j >= 0; j--) {
                    const spark = c.sparkParticles[j];
                    const sparkAlpha = (1 - (spark.life / spark.maxLife)) * alpha;
                    const sparkX = c.x - c.vx * 3 + Math.sin(spark.life * 0.08) * spark.spread;
                    const sparkY = c.y - c.vy * 3 + Math.cos(spark.life * 0.08) * spark.spread;
                    
                    if (spark.type === 'ice') {
                        ctx.fillStyle = `rgba(200, 230, 255, ${sparkAlpha * 0.8})`;
                        ctx.beginPath();
                        ctx.arc(sparkX, sparkY, spark.size, 0, Math.PI * 2);
                        ctx.fill();
                    } else if (spark.type === 'crystal') {
                        ctx.save();
                        ctx.translate(sparkX, sparkY);
                        ctx.rotate(spark.life * 0.1);
                        ctx.fillStyle = `rgba(180, 220, 255, ${sparkAlpha})`;
                        ctx.beginPath();
                        for (let k = 0; k < 6; k++) {
                            const angle = (Math.PI * 2 * k) / 6;
                            ctx.lineTo(
                                Math.cos(angle) * spark.size,
                                Math.sin(angle) * spark.size
                            );
                        }
                        ctx.closePath();
                        ctx.fill();
                        ctx.restore();
                    } else {
                        const grd = ctx.createRadialGradient(sparkX, sparkY, 0, sparkX, sparkY, spark.size * 2);
                        grd.addColorStop(0, `rgba(255, 255, 255, ${sparkAlpha})`);
                        grd.addColorStop(1, `rgba(200, 220, 255, 0)`);
                        ctx.fillStyle = grd;
                        ctx.beginPath();
                        ctx.arc(sparkX, sparkY, spark.size * 2, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    
                    spark.life++;
                    
                    if (spark.life > spark.maxLife) {
                        c.sparkParticles.splice(j, 1);
                    }
                }
                
                // GAMBAR PERCAKIAN CAHAYA LEGENDARIS DI UJUNG EKOR TIAMAT
                for (let j = c.tailEndParticles.length - 1; j >= 0; j--) {
                    const tailPart = c.tailEndParticles[j];
                    const tailAlpha = (1 - (tailPart.life / tailPart.maxLife)) * alpha;
                    const pulse = Math.sin(tailPart.life * tailPart.pulseSpeed) * 0.5 + 0.5;
                    
                    ctx.save();
                    const posX = tailEndX + tailPart.x;
                    const posY = tailEndY + tailPart.y;
                    ctx.translate(posX, posY);
                    ctx.rotate(tailPart.rotation + tailPart.life * tailPart.rotationSpeed);
                    
                    if (tailPart.type === 'spark') {
                        const grd = ctx.createRadialGradient(0, 0, 0, 0, 0, tailPart.size * 4);
                        grd.addColorStop(0, `rgba(${tailPart.color}, ${tailAlpha})`);
                        grd.addColorStop(0.7, `rgba(${tailPart.color}, ${tailAlpha * 0.3})`);
                        grd.addColorStop(1, `rgba(${tailPart.color}, 0)`);
                        
                        ctx.fillStyle = grd;
                        ctx.beginPath();
                        ctx.arc(0, 0, tailPart.size * 4 * pulse, 0, Math.PI * 2);
                        ctx.fill();
                    } 
                    else if (tailPart.type === 'glow') {
                        const grd = ctx.createRadialGradient(0, 0, 0, 0, 0, tailPart.size * 6);
                        grd.addColorStop(0, `rgba(${tailPart.color}, ${tailAlpha * 0.8})`);
                        grd.addColorStop(0.5, `rgba(${tailPart.color}, ${tailAlpha * 0.3})`);
                        grd.addColorStop(1, `rgba(${tailPart.color}, 0)`);
                        
                        ctx.fillStyle = grd;
                        ctx.beginPath();
                        ctx.arc(0, 0, tailPart.size * 6 * pulse, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    else if (tailPart.type === 'star') {
                        ctx.fillStyle = `rgba(${tailPart.color}, ${tailAlpha})`;
                        ctx.beginPath();
                        for (let k = 0; k < 5; k++) {
                            const angle = (Math.PI * 2 * k) / 5;
                            const spike = tailPart.size * 2 * pulse;
                            const indent = tailPart.size * 0.7;
                            
                            ctx.lineTo(
                                Math.cos(angle) * spike,
                                Math.sin(angle) * spike
                            );
                            ctx.lineTo(
                                Math.cos(angle + Math.PI / 5) * indent,
                                Math.sin(angle + Math.PI / 5) * indent
                            );
                        }
                        ctx.closePath();
                        ctx.fill();
                    }
                    else if (tailPart.type === 'nebula') {
                        const grd = ctx.createRadialGradient(0, 0, 0, 0, 0, tailPart.size * 8);
                        grd.addColorStop(0, `rgba(${tailPart.color}, ${tailAlpha * 0.6})`);
                        grd.addColorStop(0.3, `rgba(150, 180, 255, ${tailAlpha * 0.3})`);
                        grd.addColorStop(1, `rgba(100, 140, 255, 0)`);
                        
                        ctx.fillStyle = grd;
                        ctx.beginPath();
                        ctx.arc(0, 0, tailPart.size * 8 * pulse, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    
                    ctx.restore();
                    
                    // Update partikel ujung ekor
                    tailPart.x += tailPart.vx;
                    tailPart.y += tailPart.vy;
                    tailPart.life++;
                    
                    // Tambahkan efek memudar
                    tailPart.vx *= 0.97;
                    tailPart.vy *= 0.97;
                    
                    if (tailPart.life > tailPart.maxLife) {
                        c.tailEndParticles.splice(j, 1);
                    }
                }
                
                // Gambar kepala komet Tiamat yang megah
                ctx.save();
                ctx.translate(c.x, c.y);
                ctx.rotate(c.rotation + c.life * 0.003);
                
                // Inti komet Tiamat
                const coreGradient = ctx.createRadialGradient(0, 0, 0, 0, 0, c.size);
                coreGradient.addColorStop(0, 'rgba(255, 255, 240, 0.9)');
                coreGradient.addColorStop(0.7, 'rgba(255, 250, 200, 0.6)');
                coreGradient.addColorStop(1, 'rgba(255, 240, 180, 0)');
                
                ctx.fillStyle = coreGradient;
                ctx.beginPath();
                ctx.arc(0, 0, c.size, 0, Math.PI * 2);
                ctx.fill();
                
                // Detil tekstur Tiamat
                ctx.fillStyle = `rgba(200, 190, 170, ${alpha * 0.8})`;
                ctx.beginPath();
                ctx.ellipse(-c.size * 0.3, -c.size * 0.2, c.size * 0.4, c.size * 0.3, Math.PI / 6, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = `rgba(180, 170, 160, ${alpha * 0.6})`;
                ctx.beginPath();
                ctx.ellipse(c.size * 0.2, c.size * 0.25, c.size * 0.35, c.size * 0.25, -Math.PI / 8, 0, Math.PI * 2);
                ctx.fill();
                
                // Glow megah di sekitar kepala komet Tiamat
                const glowGrd = ctx.createRadialGradient(0, 0, c.size * 0.5, 0, 0, c.size * 4);
                glowGrd.addColorStop(0, `rgba(255, 250, 220, ${alpha * 0.7})`);
                glowGrd.addColorStop(0.5, `rgba(220, 235, 255, ${alpha * 0.3})`);
                glowGrd.addColorStop(1, `rgba(200, 220, 255, 0)`);
                ctx.fillStyle = glowGrd;
                ctx.beginPath();
                ctx.arc(0, 0, c.size * 4, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.restore();
                
                // Tambahkan partikel baru untuk ekor legendaris
                if (c.life % 2 === 0 && c.particles.length < 100) {
                    c.particles.push({
                        x: c.x,
                        y: c.y,
                        vx: c.vx * rand(0.9, 1.1),
                        vy: c.vy * rand(0.9, 1.1),
                        life: 0,
                        maxLife: rand(400, 900),
                        size: rand(1.5, 5),
                        spread: rand(1, 5),
                        color: `hsl(${rand(180, 220)}, 80%, 70%)`
                    });
                }
                
                // Tambahkan kristal es baru
                if (c.life % 3 === 0 && c.sparkParticles.length < 50) {
                    c.sparkParticles.push({
                        x: c.x,
                        y: c.y,
                        vx: c.vx * rand(0.3, 1.7),
                        vy: c.vy * rand(0.3, 1.7),
                        life: 0,
                        maxLife: rand(80, 200),
                        size: rand(0.5, 3),
                        spread: rand(3, 8),
                        type: pick(['ice', 'crystal', 'spark'])
                    });
                }
                
                // Tambahkan percikan cahaya legendaris baru di ujung ekor
                if (c.life % 2 === 0 && c.tailEndParticles.length < 60) {
                    c.tailEndParticles.push({
                        x: tailEndX - c.x,
                        y: tailEndY - c.y,
                        vx: rand(-4, 4),
                        vy: rand(-4, 4),
                        life: 0,
                        maxLife: rand(100, 300),
                        size: rand(3, 8),
                        color: pick(['255,255,255', '200,230,255', '170,200,255', '255,220,180']),
                        type: pick(['spark', 'glow', 'star', 'nebula']),
                        rotation: rand(0, Math.PI * 2),
                        rotationSpeed: rand(-0.15, 0.15),
                        pulseSpeed: rand(0.02, 0.08)
                    });
                }

                c.x += c.vx;
                c.y += c.vy;
                c.life++;
                
                if (c.life > c.maxLife || c.x > canvas.width / DPR + 1000 || c.y > canvas.height / DPR + 1000) {
                    comets.splice(i, 1);
                }
            }
        }

        // Gambar overlay langit
        function drawSkyOverlay() {
            const w = canvas.width / DPR, h = canvas.height / DPR;
            const g = ctx.createLinearGradient(0, 0, 0, h);
            g.addColorStop(0, 'rgba(10, 18, 34, 0.14)');
            g.addColorStop(0.45, 'rgba(3, 17, 30, 0.06)');
            g.addColorStop(1, 'rgba(30, 10, 40, 0.12)');
            ctx.fillStyle = g;
            ctx.fillRect(0, 0, w, h);
        }

        // Tambahkan bintang statis
        function addMoreStars() {
            STAR_COUNT = Math.min(STAR_COUNT + 100, 2000);
            initializeStars();
        }

        // Kurangi bintang statis
        function removeStars() {
            STAR_COUNT = Math.max(STAR_COUNT - 100, 100);
            initializeStars();
        }

        // Sistem playlist musik
        const playlistData = [
            { title: "Musik Pengantar", file: "musik/musik_pengantar.opus" },
            { title: "Melodi Malam", file: "musik/melodi_malam.mp3" },
            { title: "Harmoni Bintang", file: "musik/harmoni_bintang.opus" },
            { title: "Simfoni Langit", file: "musik/simfoni_langit.mp3" }
        ];

        let currentTrackIndex = 0;
        let isShuffle = false;
        let isPlaying = false;

        // Fungsi untuk mengatur playlist
        function setupPlaylist() {
            const playlistElement = document.getElementById('playlist');
            playlistElement.innerHTML = '';
            
            playlistData.forEach((track, index) => {
                const item = document.createElement('div');
                item.className = 'playlist-item';
                if (index === currentTrackIndex) {
                    item.classList.add('active');
                }
                item.textContent = track.title;
                item.addEventListener('click', () => {
                    playTrack(index);
                });
                playlistElement.appendChild(item);
            });
        }

        // Fungsi untuk memutar lagu
        function playTrack(index) {
            if (index < 0 || index >= playlistData.length) return;
            
            currentTrackIndex = index;
            const track = playlistData[currentTrackIndex];
            
            backgroundMusic.src = track.file;
            backgroundMusic.load();
            
            // Update UI
            updatePlaylistUI();
            musicInfo.textContent = `Memutar: ${track.title}`;
            
            backgroundMusic.play().then(() => {
                isPlaying = true;
                updatePlayPauseButton();
            }).catch(e => {
                console.error("Gagal memutar musik:", e);
                musicInfo.textContent = "Klik untuk memutar musik";
            });
        }

        // Fungsi untuk memperbarui UI playlist
        function updatePlaylistUI() {
            const items = document.querySelectorAll('.playlist-item');
            items.forEach((item, index) => {
                if (index === currentTrackIndex) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // Fungsi untuk memperbarui tombol play/pause
        function updatePlayPauseButton() {
            const icon = playPauseBtn.querySelector('i');
            if (isPlaying) {
                icon.className = 'fas fa-pause';
                playPauseBtn.querySelector('.tooltip').textContent = 'Jeda';
            } else {
                icon.className = 'fas fa-play';
                playPauseBtn.querySelector('.tooltip').textContent = 'Putar';
            }
        }

        // Fungsi untuk memutar lagu berikutnya
        function nextTrack() {
            let nextIndex;
            
            if (isShuffle) {
                // Mode acak
                do {
                    nextIndex = Math.floor(Math.random() * playlistData.length);
                } while (nextIndex === currentTrackIndex && playlistData.length > 1);
            } else {
                // Mode urutan
                nextIndex = (currentTrackIndex + 1) % playlistData.length;
            }
            
            playTrack(nextIndex);
        }

        // Fungsi untuk memutar lagu sebelumnya
        function prevTrack() {
            let prevIndex;
            
            if (isShuffle) {
                // Mode acak
                do {
                    prevIndex = Math.floor(Math.random() * playlistData.length);
                } while (prevIndex === currentTrackIndex && playlistData.length > 1);
            } else {
                // Mode urutan
                prevIndex = (currentTrackIndex - 1 + playlistData.length) % playlistData.length;
            }
            
            playTrack(prevIndex);
        }

        // Fungsi untuk mengontrol musik
        function setupMusicControls() {
            // Setup playlist
            setupPlaylist();
            
            // Event listeners untuk kontrol musik
            playPauseBtn.addEventListener('click', function() {
                if (isPlaying) {
                    backgroundMusic.pause();
                    isPlaying = false;
                } else {
                    backgroundMusic.play().then(() => {
                        isPlaying = true;
                    }).catch(e => {
                        console.error("Gagal memutar musik:", e);
                        musicInfo.textContent = "Klik untuk memutar musik";
                    });
                }
                updatePlayPauseButton();
            });
            
            prevTrackBtn.addEventListener('click', prevTrack);
            
            nextTrackBtn.addEventListener('click', nextTrack);
            
            shuffleToggleBtn.addEventListener('click', function() {
                isShuffle = !isShuffle;
                if (isShuffle) {
                    shuffleToggleBtn.classList.add('active');
                    shuffleToggleBtn.querySelector('.tooltip').textContent = 'Mode Urutan';
                } else {
                    shuffleToggleBtn.classList.remove('active');
                    shuffleToggleBtn.querySelector('.tooltip').textContent = 'Mode Acak';
                }
            });
            
            playlistToggleBtn.addEventListener('click', function() {
                playlist.classList.toggle('show');
            });
            
            // Event listeners untuk elemen audio
            backgroundMusic.addEventListener('ended', nextTrack);
            
            backgroundMusic.addEventListener('play', function() {
                isPlaying = true;
                updatePlayPauseButton();
                musicInfo.textContent = `Memutar: ${playlistData[currentTrackIndex].title}`;
            });
            
            backgroundMusic.addEventListener('pause', function() {
                isPlaying = false;
                updatePlayPauseButton();
                musicInfo.textContent = `Dijeda: ${playlistData[currentTrackIndex].title}`;
            });
            
            backgroundMusic.addEventListener('error', function() {
                musicInfo.textContent = "Error memuat musik";
                console.error("Error loading audio:", backgroundMusic.error);
            });
            
            // Mulai memutar lagu pertama
            playTrack(0);
        }

        // Main loop
        function loop(t) {
            const time = t / 1000;
            const w = canvas.width / DPR;
            const h = canvas.height / DPR;
            ctx.clearRect(0, 0, w, h);

            drawSkyOverlay();
            drawMoon();
            drawStars(time);
            
            if (Math.random() < SHOOTING_FREQ) spawnShootingStar();
            if (Math.random() < COMET_FREQ) spawnTiamatComet();
            
            drawShootingStars();
            drawComets();

            requestAnimationFrame(loop);
        }

        // Event listeners untuk interaksi
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const cx = (e.clientX - rect.left);
            const cy = (e.clientY - rect.top);
            spawnShootingStar(cx, cy);
        });

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const t = e.touches[0];
            const cx = (t.clientX - rect.left);
            const cy = (t.clientY - rect.top);
            spawnShootingStar(cx, cy);
        });

        moreStarsBtn.addEventListener('click', addMoreStars);
        lessStarsBtn.addEventListener('click', removeStars);
        shootingStarBtn.addEventListener('click', () => spawnShootingStar());
        cometBtn.addEventListener('click', () => spawnTiamatComet());

        // Toggle panel kontrol
        panelToggle.addEventListener('click', () => {
            controlsPanel.classList.toggle('collapsed');
            if (controlsPanel.classList.contains('collapsed')) {
                panelIcon.className = 'fas fa-chevron-up';
            } else {
                panelIcon.className = 'fas fa-chevron-down';
            }
        });

        // Handle error gambar logo
        const schoolLogo = document.getElementById('schoolLogo');
        schoolLogo.addEventListener('error', function() {
            console.log('Logo tidak ditemukan, menggunakan placeholder');
            // Bisa ditambahkan placeholder atau teks alternatif di sini
        });

        // Inisialisasi
        for (let i = 0; i < 3; i++) spawnShootingStar();
        if (Math.random() < 0.2) setTimeout(() => spawnTiamatComet(), 3000);

        // Setup kontrol musik
        setupMusicControls();

        // Mulai animasi
        requestAnimationFrame(loop);
    </script>
</body>
</html>