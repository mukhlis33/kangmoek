<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIP DA - Presensi Digital</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1a936f;
            --primary-dark: #114b47;
            --secondary: #88d498;
            --accent: #c6dabf;
            --surface: #ffffff;
            --background: #f8f9fa;
            --on-primary: #ffffff;
            --on-surface: #2b2b2b;
            --on-background: #5a5a5a;
            --border: #e0e0e0;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
            --radius: 12px;
            --danger: #e74c3c;
            --warning: #f39c12;
            --success: #27ae60;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background);
            color: var(--on-surface);
            line-height: 1.6;
            padding-bottom: 80px;
        }

        .container {
            max-width: 100%;
            padding: 0 16px;
        }

        /* HEADER */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--on-primary);
            padding: 20px 0;
            position: relative;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-info h1 {
            font-size: 1.3rem;
            margin-bottom: 5px;
        }

        .header-info p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: var(--on-primary);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        /* MAIN CONTENT */
        .main-content {
            padding: 20px 0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* CARDS */
        .card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
        }

        /* TIME INFO */
        .time-info {
            text-align: center;
        }

        .current-time {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .schedule-info {
            display: flex;
            justify-content: space-around;
            margin-top: 12px;
        }

        .schedule-item {
            text-align: center;
        }

        .schedule-item .label {
            font-size: 0.8rem;
            color: var(--on-background);
            margin-bottom: 4px;
        }

        .schedule-item .time {
            font-weight: bold;
            color: var(--on-surface);
        }

        .countdown {
            font-size: 0.9rem;
            margin-top: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            display: inline-block;
        }

        .countdown.early {
            background: var(--accent);
            color: var(--primary-dark);
        }

        .countdown.late {
            background: var(--danger);
            color: white;
        }

        .countdown.going-home {
            background: var(--warning);
            color: white;
        }

        /* PRESENSI OPTIONS */
        .presensi-options {
            display: grid;
            gap: 12px;
            margin: 20px 0;
        }

        .presensi-option {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            text-align: left;
        }

        .presensi-option.active {
            border-color: var(--primary);
            background: var(--accent);
        }

        .option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .option-header h3 {
            color: var(--primary-dark);
        }

        .option-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .badge-wfo {
            background: var(--primary);
            color: white;
        }

        .badge-wfh {
            background: var(--warning);
            color: white;
        }

        .option-description {
            color: var(--on-background);
            font-size: 0.9rem;
            margin-bottom: 12px;
        }

        /* BUTTONS */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--on-primary);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-primary:disabled {
            background: var(--on-background);
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--background);
            color: var(--on-surface);
            border: 1px solid var(--border);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .btn-full {
            width: 100%;
        }

        /* BOTTOM NAV */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface);
            border-top: 1px solid var(--border);
            display: flex;
            padding: 8px 0;
            z-index: 1000;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--on-background);
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-icon {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }

        .nav-label {
            font-size: 0.7rem;
            font-weight: 500;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 24px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--on-background);
        }

        /* FORM ELEMENTS */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* CAMERA PREVIEW */
        .camera-preview {
            width: 100%;
            max-width: 300px;
            height: 200px;
            background: var(--background);
            border-radius: var(--radius);
            margin: 16px auto;
            border: 2px dashed var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--on-background);
        }

        .camera-preview video,
        .camera-preview canvas {
            width: 100%;
            height: 100%;
            border-radius: var(--radius);
            object-fit: cover;
        }

        /* LOCATION STATUS */
        .location-status {
            padding: 12px;
            border-radius: var(--radius);
            margin: 12px 0;
            text-align: center;
        }

        .location-status.success {
            background: var(--accent);
            color: var(--primary-dark);
        }

        .location-status.error {
            background: #ffebee;
            color: var(--danger);
        }

        /* ADMIN STYLES */
        .admin-section {
            margin-bottom: 24px;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--background);
            border-radius: var(--radius);
            margin-bottom: 8px;
        }

        .user-actions {
            display: flex;
            gap: 8px;
        }

        .time-setting-day {
            background: var(--background);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
        }

        .day-header {
            font-weight: bold;
            margin-bottom: 12px;
            color: var(--primary-dark);
        }

        .time-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            align-items: end;
        }

        /* STATUS */
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-success {
            color: var(--success);
        }

        .status-warning {
            color: var(--warning);
        }
    </style>
</head>
<body>
    <!-- LOGIN PAGE -->
    <div id="loginPage">
        <div class="container" style="max-width: 400px; margin: 100px auto; padding: 20px;">
            <div class="card" style="text-align: center;">
                <div style="font-size: 3rem; color: var(--primary); margin-bottom: 20px;">
                    <i class="fas fa-fingerprint"></i>
                </div>
                <h1 style="color: var(--primary-dark); margin-bottom: 10px;">SIP DA</h1>
                <p style="color: var(--on-background); margin-bottom: 30px;">Sistem Presensi Digital</p>
                
                <form id="loginForm">
                    <div class="form-group">
                        <input type="text" id="username" placeholder="Username" required>
                    </div>
                    <div class="form-group">
                        <input type="password" id="password" placeholder="Password" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" style="display: none;">
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <div class="header-info">
                        <h1 id="greeting">Halo, User! ðŸ‘‹</h1>
                        <p>SIP DA - Presensi Digital</p>
                    </div>
                    <button class="logout-btn" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="container">
                
                <!-- TAB: ABSEN -->
                <div id="absen" class="tab-content active">
                    <!-- TIME INFO -->
                    <div class="card time-info">
                        <div class="current-time" id="currentTime">00:00:00</div>
                        <div class="countdown early" id="countdown">Memuat...</div>
                        
                        <div class="schedule-info">
                            <div class="schedule-item">
                                <div class="label">Presensi Masuk</div>
                                <div class="time" id="masukTime">08:00</div>
                            </div>
                            <div class="schedule-item">
                                <div class="label">Presensi Pulang</div>
                                <div class="time" id="pulangTime">16:00</div>
                            </div>
                        </div>
                    </div>

                    <!-- TODAY STATUS -->
                    <div class="card">
                        <h3 style="margin-bottom: 16px;">Status Hari Ini</h3>
                        <div class="status-item">
                            <span>Presensi Masuk:</span>
                            <span id="statusMasuk" class="status-warning">Belum</span>
                        </div>
                        <div class="status-item">
                            <span>Presensi Pulang:</span>
                            <span id="statusPulang" class="status-warning">Belum</span>
                        </div>
                    </div>

                    <!-- PRESENSI OPTIONS -->
                    <div class="presensi-options">
                        <!-- WFO OPTION -->
                        <div class="presensi-option active">
                            <div class="option-header">
                                <h3>Work From Office (WFO)</h3>
                                <span class="option-badge badge-wfo">REKOMENDASI</span>
                            </div>
                            <p class="option-description">Posisi anda sudah masuk koordinat (SMK Darulabror)</p>
                            <button class="btn btn-primary btn-full" id="presensiMasukBtn">
                                <i class="fas fa-camera"></i> Presensi Masuk
                            </button>
                            <button class="btn btn-secondary btn-full" id="presensiPulangBtn" style="margin-top: 8px;">
                                <i class="fas fa-home"></i> Presensi Pulang
                            </button>
                        </div>

                        <!-- WFH OPTION -->
                        <div class="presensi-option">
                            <div class="option-header">
                                <h3>Work From Home (WFH)</h3>
                                <span class="option-badge badge-wfh">PERLU IZIN</span>
                            </div>
                            <p class="option-description">Atas izin kepala sekolah dengan mengajukan permohonan</p>
                            <button class="btn btn-secondary btn-full" id="ajukanWFHBtn">
                                <i class="fas fa-envelope"></i> Ajukan WFH
                            </button>
                        </div>
                    </div>
                </div>

                <!-- TAB: HISTORY -->
                <div id="history" class="tab-content">
                    <div class="card">
                        <h3 style="margin-bottom: 16px;">Riwayat Presensi</h3>
                        <div id="historyList">
                            <p style="text-align: center; color: var(--on-background); padding: 20px;">
                                Belum ada riwayat presensi
                            </p>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 16px;">
                            <button class="btn btn-primary" id="generatePDFBtn">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                            <button class="btn btn-secondary" id="generateJPEGBtn">
                                <i class="fas fa-file-image"></i> JPEG
                            </button>
                        </div>
                    </div>
                </div>

                <!-- TAB: PROFILE -->
                <div id="profile" class="tab-content">
                    <div class="card">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="width: 80px; height: 80px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin: 0 auto 16px;">
                                <i class="fas fa-user"></i>
                            </div>
                            <h3 id="profileName">User</h3>
                            <p id="profileRole" style="color: var(--on-background);">Role</p>
                        </div>
                        
                        <form id="profileForm">
                            <div class="form-group">
                                <label>Nama Lengkap</label>
                                <input type="text" id="profileNama" required>
                            </div>
                            <div class="form-group">
                                <label>Password Baru</label>
                                <input type="password" id="profilePassword" placeholder="Kosongkan jika tidak ingin mengubah">
                            </div>
                            <button type="submit" class="btn btn-primary btn-full">
                                <i class="fas fa-save"></i> Simpan Perubahan
                            </button>
                        </form>
                    </div>
                </div>

                <!-- TAB: ADMIN -->
                <div id="admin" class="tab-content">
                    <div class="card">
                        <!-- MANAJEMEN PENGGUNA -->
                        <div class="admin-section">
                            <h3><i class="fas fa-users"></i> Manajemen Pengguna</h3>
                            <button class="btn btn-primary" id="addUserBtn">
                                <i class="fas fa-plus"></i> Tambah Pengguna
                            </button>
                            
                            <div class="user-list" id="userList" style="margin-top: 16px;">
                                <!-- Daftar user akan dimuat di sini -->
                            </div>
                        </div>

                        <!-- PENGATURAN WAKTU -->
                        <div class="admin-section">
                            <h3><i class="fas fa-clock"></i> Pengaturan Waktu Presensi</h3>
                            <div id="timeSettings">
                                <!-- Pengaturan waktu akan dimuat di sini -->
                            </div>
                            <button class="btn btn-primary" onclick="app.saveTimeSettings()" style="margin-top: 12px;">
                                <i class="fas fa-save"></i> Simpan Pengaturan Waktu
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </main>

        <!-- BOTTOM NAVIGATION -->
        <nav class="bottom-nav">
            <button class="nav-item active" data-tab="absen">
                <i class="fas fa-fingerprint nav-icon"></i>
                <span class="nav-label">Absen</span>
            </button>
            
            <button class="nav-item" data-tab="history">
                <i class="fas fa-history nav-icon"></i>
                <span class="nav-label">History</span>
            </button>
            
            <button class="nav-item" data-tab="profile">
                <i class="fas fa-user nav-icon"></i>
                <span class="nav-label">Profile</span>
            </button>
            
            <button class="nav-item" data-tab="admin" id="adminNavButton">
                <i class="fas fa-shield-alt nav-icon"></i>
                <span class="nav-label">Admin</span>
            </button>
        </nav>
    </div>

    <!-- MODALS -->
    <div class="modal" id="presensiModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="presensiModalTitle">Presensi</h3>
                <button class="modal-close" onclick="closeModal('presensiModal')">Ã—</button>
            </div>
            <div class="modal-body">
                <div id="locationStatus" class="location-status">
                    <i class="fas fa-spinner fa-spin"></i> Memeriksa lokasi...
                </div>
                
                <div id="cameraSection" style="display: none;">
                    <div class="camera-preview" id="cameraPreview">
                        <span>Kamera akan diaktifkan...</span>
                    </div>
                    <button class="btn btn-primary btn-full" id="captureBtn" style="margin-top: 16px;">
                        <i class="fas fa-camera"></i> Ambil Foto
                    </button>
                </div>

                <div id="presensiSuccess" style="display: none; text-align: center;">
                    <i class="fas fa-check-circle" style="font-size: 3rem; color: var(--success); margin-bottom: 16px;"></i>
                    <h3>Presensi Berhasil!</h3>
                    <p id="successMessage"></p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="addUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Tambah Pengguna Baru</h3>
                <button class="modal-close" onclick="closeModal('addUserModal')">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="form-group">
                        <label>Nama Lengkap</label>
                        <input type="text" id="newUserName" required>
                    </div>
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="newUserUsername" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="newUserPassword" required>
                    </div>
                    <div class="form-group">
                        <label>Role</label>
                        <select id="newUserRole" required>
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                            <option value="sip">Guru/Karyawan SIP</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">
                        <i class="fas fa-save"></i> Simpan Pengguna
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal" id="wfhModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Pengajuan Work From Home</h3>
                <button class="modal-close" onclick="closeModal('wfhModal')">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="wfhForm">
                    <div class="form-group">
                        <label>Tanggal WFH</label>
                        <input type="date" id="wfhDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Alasan WFH</label>
                        <select id="wfhReason" required>
                            <option value="">Pilih alasan</option>
                            <option value="sakit">Sakit</option>
                            <option value="keluarga">Keperluan Keluarga</option>
                            <option value="dinas">Dinas Luar</option>
                            <option value="lainnya">Lainnya</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Keterangan Detail</label>
                        <textarea id="wfhDetail" placeholder="Jelaskan alasan WFH secara detail..." required></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-full">
                        <i class="fas fa-paper-plane"></i> Ajukan ke Kepala Sekolah
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // SIMPLE DATABASE WITH SQLite-like OPERATIONS
        class Database {
            constructor() {
                this.tables = {
                    users: 'sipda_users',
                    presensi: 'sipda_presensi',
                    settings: 'sipda_settings'
                };
                this.init();
            }

            init() {
                // Initialize default data
                if (!this.get('users')) {
                    this.set('users', [
                        { id: 1, username: 'admin', password: 'admin123', role: 'admin', nama: 'Administrator' },
                        { id: 2, username: 'mukhlis', password: 'user123', role: 'user', nama: 'Mukhlis' },
                        { id: 3, username: 'sip01', password: 'sip123', role: 'sip', nama: 'Guru SIP' }
                    ]);
                }

                if (!this.get('presensi')) {
                    this.set('presensi', []);
                }

                if (!this.get('settings')) {
                    this.set('settings', {
                        schoolLocation: { 
                            lat: -7.250445, 
                            lng: 112.768845, 
                            radius: 100 
                        },
                        workHours: {
                            'Senin': { masuk: '07:00', pulang: '16:00' },
                            'Selasa': { masuk: '07:00', pulang: '16:00' },
                            'Rabu': { masuk: '07:00', pulang: '16:00' },
                            'Kamis': { masuk: '07:00', pulang: '16:00' },
                            'Jumat': { masuk: '07:00', pulang: '16:00' },
                            'Sabtu': { masuk: '08:00', pulang: '12:00' },
                            'Minggu': { masuk: '00:00', pulang: '00:00' }
                        },
                        sipHours: {
                            masuk: '06:30',
                            pulang: '17:00'
                        }
                    });
                }
            }

            get(table) {
                const data = localStorage.getItem(this.tables[table]);
                return data ? JSON.parse(data) : null;
            }

            set(table, data) {
                localStorage.setItem(this.tables[table], JSON.stringify(data));
            }

            insert(table, record) {
                const data = this.get(table) || [];
                record.id = Date.now() + Math.random();
                data.push(record);
                this.set(table, data);
                return record.id;
            }

            update(table, id, updates) {
                const data = this.get(table) || [];
                const index = data.findIndex(item => item.id === id);
                if (index !== -1) {
                    data[index] = { ...data[index], ...updates };
                    this.set(table, data);
                    return true;
                }
                return false;
            }

            delete(table, id) {
                const data = this.get(table) || [];
                const filtered = data.filter(item => item.id !== id);
                this.set(table, filtered);
                return filtered.length !== data.length;
            }

            query(table, condition = {}) {
                let data = this.get(table) || [];
                if (Object.keys(condition).length === 0) return data;
                
                return data.filter(item => {
                    return Object.keys(condition).every(key => item[key] === condition[key]);
                });
            }
        }

        // GEOLOCATION SERVICE
        class GeolocationService {
            constructor() {
                this.schoolLocation = { lat: -7.250445, lng: 112.768845 };
                this.allowedRadius = 100; // meters
            }

            getCurrentLocation() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject('Geolocation tidak didukung browser');
                        return;
                    }

                    navigator.geolocation.getCurrentPosition(
                        position => resolve({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        }),
                        error => reject(this.getErrorMsg(error)),
                        { 
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        }
                    );
                });
            }

            getErrorMsg(error) {
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        return 'Akses lokasi ditolak. Izinkan akses lokasi untuk presensi.';
                    case error.POSITION_UNAVAILABLE:
                        return 'Informasi lokasi tidak tersedia.';
                    case error.TIMEOUT:
                        return 'Request lokasi timeout.';
                    default:
                        return 'Error tidak diketahui.';
                }
            }

            calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371000; // Earth radius in meters
                const dLat = this.toRad(lat2 - lat1);
                const dLon = this.toRad(lon2 - lon1);
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                          Math.cos(this.toRad(lat1)) * Math.cos(this.toRad(lat2)) *
                          Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }

            toRad(degrees) {
                return degrees * (Math.PI/180);
            }

            async isWithinSchoolRadius() {
                try {
                    const coords = await this.getCurrentLocation();
                    const distance = this.calculateDistance(
                        coords.latitude, coords.longitude,
                        this.schoolLocation.lat, this.schoolLocation.lng
                    );
                    
                    return {
                        withinRadius: distance <= this.allowedRadius,
                        distance: Math.round(distance),
                        coords: coords,
                        accuracy: coords.accuracy
                    };
                } catch (error) {
                    throw new Error(error);
                }
            }
        }

        // CAMERA SERVICE
        class CameraService {
            constructor() {
                this.stream = null;
                this.video = null;
                this.canvas = null;
            }

            async startCamera(videoElement) {
                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        } 
                    });
                    
                    this.video = videoElement;
                    this.video.srcObject = this.stream;
                    this.video.play();
                    
                    return true;
                } catch (error) {
                    throw new Error('Tidak dapat mengakses kamera: ' + error.message);
                }
            }

            capturePhoto() {
                if (!this.video) throw new Error('Kamera belum diaktifkan');
                
                if (!this.canvas) {
                    this.canvas = document.createElement('canvas');
                    this.canvas.width = this.video.videoWidth;
                    this.canvas.height = this.video.videoHeight;
                }
                
                const context = this.canvas.getContext('2d');
                context.drawImage(this.video, 0, 0);
                
                return this.canvas.toDataURL('image/jpeg', 0.8);
            }

            stopCamera() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                if (this.video) {
                    this.video.srcObject = null;
                }
            }
        }

        // MAIN APPLICATION
        class SIPDAApp {
            constructor() {
                this.db = new Database();
                this.geolocation = new GeolocationService();
                this.camera = new CameraService();
                this.currentUser = null;
                this.currentPresensiType = null;
                this.init();
            }

            init() {
                this.checkAuth();
                this.setupEventListeners();
                this.startClock();
            }

            checkAuth() {
                const loggedInUser = localStorage.getItem('sipda_current_user');
                if (loggedInUser) {
                    this.currentUser = JSON.parse(loggedInUser);
                    this.showMainApp();
                }
            }

            async login(username, password) {
                const users = this.db.query('users', { username, password });
                if (users.length > 0) {
                    this.currentUser = users[0];
                    localStorage.setItem('sipda_current_user', JSON.stringify(this.currentUser));
                    this.showMainApp();
                    return true;
                }
                return false;
            }

            logout() {
                this.currentUser = null;
                localStorage.removeItem('sipda_current_user');
                this.showLogin();
            }

            showMainApp() {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                this.updateUserInfo();
                this.updateUI();
            }

            showLogin() {
                document.getElementById('loginPage').style.display = 'block';
                document.getElementById('mainApp').style.display = 'none';
            }

            updateUserInfo() {
                if (!this.currentUser) return;
                
                document.getElementById('greeting').textContent = `Halo, ${this.currentUser.nama}! ðŸ‘‹`;
                document.getElementById('profileName').textContent = this.currentUser.nama;
                document.getElementById('profileRole').textContent = this.getRoleDisplay(this.currentUser.role);
                document.getElementById('profileNama').value = this.currentUser.nama;

                // Hide admin tab for non-admin users
                if (this.currentUser.role !== 'admin') {
                    document.getElementById('adminNavButton').style.display = 'none';
                } else {
                    document.getElementById('adminNavButton').style.display = 'flex';
                    this.loadAdminData();
                }
            }

            getRoleDisplay(role) {
                const roles = {
                    'admin': 'Administrator',
                    'user': 'User',
                    'sip': 'Guru/Karyawan SIP'
                };
                return roles[role] || role;
            }

            // PRESENSI WITH GEOLOCATION & CAMERA
            async startPresensi(type) {
                this.currentPresensiType = type;
                showModal('presensiModal');
                document.getElementById('presensiModalTitle').textContent = `Presensi ${type === 'masuk' ? 'Masuk' : 'Pulang'}`;
                
                // Reset modal state
                document.getElementById('locationStatus').style.display = 'block';
                document.getElementById('cameraSection').style.display = 'none';
                document.getElementById('presensiSuccess').style.display = 'none';
                
                try {
                    // Check location first
                    const locationCheck = await this.geolocation.isWithinSchoolRadius();
                    
                    if (locationCheck.withinRadius) {
                        document.getElementById('locationStatus').innerHTML = 
                            `<i class="fas fa-check-circle"></i> Anda berada dalam jangkauan presensi (${locationCheck.distance}m dari sekolah)`;
                        document.getElementById('locationStatus').className = 'location-status success';
                        
                        // Show camera section
                        document.getElementById('cameraSection').style.display = 'block';
                        
                        // Start camera
                        const video = document.createElement('video');
                        video.setAttribute('playsinline', '');
                        video.setAttribute('autoplay', '');
                        document.getElementById('cameraPreview').innerHTML = '';
                        document.getElementById('cameraPreview').appendChild(video);
                        
                        await this.camera.startCamera(video);
                        
                    } else {
                        document.getElementById('locationStatus').innerHTML = 
                            `<i class="fas fa-times-circle"></i> Anda berada di luar jangkauan presensi (${locationCheck.distance}m dari sekolah). Harus dalam radius ${this.geolocation.allowedRadius}m.`;
                        document.getElementById('locationStatus').className = 'location-status error';
                        document.getElementById('captureBtn').disabled = true;
                    }
                    
                } catch (error) {
                    document.getElementById('locationStatus').innerHTML = 
                        `<i class="fas fa-times-circle"></i> ${error.message}`;
                    document.getElementById('locationStatus').className = 'location-status error';
                    document.getElementById('captureBtn').disabled = true;
                }
            }

            async capturePresensi() {
                try {
                    const photoData = this.camera.capturePhoto();
                    
                    // Save presensi record
                    const presensiRecord = {
                        user_id: this.currentUser.id,
                        user_nama: this.currentUser.nama,
                        type: this.currentPresensiType,
                        timestamp: new Date().toISOString(),
                        status: 'Hadir',
                        waktu: new Date().toLocaleTimeString('id-ID'),
                        photo: photoData,
                        location: await this.geolocation.getCurrentLocation()
                    };

                    this.db.insert('presensi', presensiRecord);
                    
                    // Show success
                    document.getElementById('cameraSection').style.display = 'none';
                    document.getElementById('presensiSuccess').style.display = 'block';
                    document.getElementById('successMessage').textContent = 
                        `Presensi ${this.currentPresensiType} berhasil dicatat pada ${new Date().toLocaleString('id-ID')}`;
                    
                    // Stop camera
                    this.camera.stopCamera();
                    
                    // Auto close modal after 2 seconds
                    setTimeout(() => {
                        closeModal('presensiModal');
                        this.updateUI();
                    }, 2000);
                    
                } catch (error) {
                    alert('Error mengambil foto: ' + error.message);
                }
            }

            // ADMIN FUNCTIONS
            loadAdminData() {
                this.loadUserList();
                this.loadTimeSettings();
            }

            loadUserList() {
                const users = this.db.query('users');
                const userList = document.getElementById('userList');
                
                if (users.length === 0) {
                    userList.innerHTML = '<p>Belum ada user</p>';
                    return;
                }

                userList.innerHTML = users.map(user => `
                    <div class="user-item">
                        <div>
                            <strong>${user.nama}</strong>
                            <div style="font-size: 0.8rem; color: var(--on-background);">
                                ${user.username} | ${this.getRoleDisplay(user.role)}
                            </div>
                        </div>
                        <div class="user-actions">
                            <button class="btn btn-danger btn-small" onclick="app.deleteUser(${user.id})" 
                                    ${user.id === this.currentUser.id ? 'disabled' : ''}>
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            loadTimeSettings() {
                const settings = this.db.get('settings');
                const workHours = settings.workHours || {};
                const days = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu', 'Minggu'];
                
                const timeSettingsHTML = days.map(day => {
                    const times = workHours[day] || { masuk: '00:00', pulang: '00:00' };
                    return `
                        <div class="time-setting-day">
                            <div class="day-header">${day}</div>
                            <div class="time-inputs">
                                <div class="form-group">
                                    <label>Masuk</label>
                                    <input type="time" value="${times.masuk}" data-day="${day}" data-type="masuk">
                                </div>
                                <div class="form-group">
                                    <label>Pulang</label>
                                    <input type="time" value="${times.pulang}" data-day="${day}" data-type="pulang">
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('timeSettings').innerHTML = timeSettingsHTML;
            }

            addUser(userData) {
                // Check if username already exists
                const existingUser = this.db.query('users', { username: userData.username });
                if (existingUser.length > 0) {
                    alert('Username sudah digunakan!');
                    return false;
                }

                this.db.insert('users', userData);
                alert('User berhasil ditambahkan!');
                this.loadUserList();
                return true;
            }

            deleteUser(userId) {
                if (userId === this.currentUser.id) {
                    alert('Tidak bisa menghapus akun sendiri!');
                    return;
                }

                if (confirm('Apakah Anda yakin ingin menghapus user ini?')) {
                    this.db.delete('users', userId);
                    alert('User berhasil dihapus!');
                    this.loadUserList();
                }
            }

            saveTimeSettings() {
                const settings = this.db.get('settings');
                const timeInputs = document.querySelectorAll('#timeSettings input[data-day]');
                
                timeInputs.forEach(input => {
                    const day = input.getAttribute('data-day');
                    const type = input.getAttribute('data-type');
                    const value = input.value;
                    
                    if (!settings.workHours[day]) {
                        settings.workHours[day] = {};
                    }
                    settings.workHours[day][type] = value;
                });
                
                this.db.set('settings', settings);
                alert('Pengaturan waktu berhasil disimpan!');
            }

            // WFH FUNCTION
            async ajukanWFH(formData) {
                const presensiRecord = {
                    user_id: this.currentUser.id,
                    user_nama: this.currentUser.nama,
                    type: 'wfh',
                    timestamp: new Date().toISOString(),
                    status: 'Menunggu Persetujuan',
                    reason: formData.reason,
                    detail: formData.detail,
                    date: formData.date
                };

                this.db.insert('presensi', presensiRecord);
                
                // Format WhatsApp message
                const message = `Assalamu'alaikum Pak Kepala Sekolah.\n\nSaya ${this.currentUser.nama} mengajukan izin Work From Home pada tanggal ${formData.date} dengan alasan ${formData.reason}.\n\nKeterangan: ${formData.detail}\n\nTerima kasih atas perhatiannya.`;
                const encodedMessage = encodeURIComponent(message);
                const whatsappURL = `https://wa.me/6281234567890?text=${encodedMessage}`;
                
                window.open(whatsappURL, '_blank');
                alert('Pengajuan WFH berhasil! Silakan lanjutkan konfirmasi via WhatsApp.');
            }

            // PROFILE UPDATE
            updateProfile(profileData) {
                if (this.db.update('users', this.currentUser.id, profileData)) {
                    this.currentUser = { ...this.currentUser, ...profileData };
                    localStorage.setItem('sipda_current_user', JSON.stringify(this.currentUser));
                    alert('Profile berhasil diupdate!');
                    this.updateUserInfo();
                    return true;
                }
                return false;
            }

            // REPORT GENERATION
            generatePDF() {
                const history = this.db.query('presensi')
                    .filter(p => p.user_id === this.currentUser.id)
                    .slice(-10)
                    .reverse();

                let printContent = `
                    <html>
                    <head>
                        <title>Laporan Presensi - ${this.currentUser.nama}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #1a936f; color: white; }
                            .header { text-align: center; margin-bottom: 20px; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>LAPORAN PRESENSI</h1>
                            <h2>${this.currentUser.nama}</h2>
                            <p>${new Date().toLocaleDateString('id-ID')}</p>
                        </div>
                        <table>
                            <tr>
                                <th>Tanggal</th>
                                <th>Jenis</th>
                                <th>Waktu</th>
                                <th>Status</th>
                            </tr>
                `;

                history.forEach(p => {
                    printContent += `
                        <tr>
                            <td>${new Date(p.timestamp).toLocaleDateString('id-ID')}</td>
                            <td>${p.type.toUpperCase()}</td>
                            <td>${p.waktu}</td>
                            <td>${p.status}</td>
                        </tr>
                    `;
                });

                printContent += `</table></body></html>`;

                const printWindow = window.open('', '_blank');
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.print();
            }

            generateJPEG() {
                alert('Fitur generate JPEG akan segera tersedia!');
            }

            // UI FUNCTIONS
            updateUI() {
                this.updatePresensiStatus();
                this.updateHistoryList();
                this.updateTimeInfo();
            }

            updatePresensiStatus() {
                const today = new Date().toDateString();
                const todayPresensi = this.db.query('presensi').filter(p => 
                    p.user_id === this.currentUser.id && 
                    new Date(p.timestamp).toDateString() === today
                );

                const hasMasuk = todayPresensi.some(p => p.type === 'masuk');
                const hasPulang = todayPresensi.some(p => p.type === 'pulang');

                document.getElementById('statusMasuk').textContent = hasMasuk ? 'âœ“ Sudah' : 'âœ— Belum';
                document.getElementById('statusMasuk').className = hasMasuk ? 'status-success' : 'status-warning';
                
                document.getElementById('statusPulang').textContent = hasPulang ? 'âœ“ Sudah' : 'âœ— Belum';
                document.getElementById('statusPulang').className = hasPulang ? 'status-success' : 'status-warning';
            }

            updateHistoryList() {
                const history = this.db.query('presensi')
                    .filter(p => p.user_id === this.currentUser.id)
                    .slice(-10)
                    .reverse();

                const historyList = document.getElementById('historyList');
                
                if (history.length === 0) {
                    historyList.innerHTML = '<p style="text-align: center; color: var(--on-background); padding: 20px;">Belum ada riwayat presensi</p>';
                    return;
                }

                historyList.innerHTML = history.map(p => `
                    <div class="status-item">
                        <div>
                            <strong>${new Date(p.timestamp).toLocaleDateString('id-ID')}</strong>
                            <div style="font-size: 0.8rem; color: var(--on-background);">
                                ${p.type.toUpperCase()} - ${p.status}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div>${p.waktu}</div>
                            <div style="font-size: 0.8rem; color: var(--on-background);">
                                ${p.reason ? p.reason : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            updateTimeInfo() {
                const now = new Date();
                const settings = this.db.get('settings');
                const today = ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'][now.getDay()];
                const workHours = settings.workHours[today] || { masuk: '08:00', pulang: '16:00' };

                document.getElementById('masukTime').textContent = workHours.masuk;
                document.getElementById('pulangTime').textContent = workHours.pulang;
            }

            startClock() {
                setInterval(() => {
                    const now = new Date();
                    document.getElementById('currentTime').textContent = 
                        now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    
                    this.updateCountdown(now);
                }, 1000);
            }

            updateCountdown(now) {
                const countdownEl = document.getElementById('countdown');
                const settings = this.db.get('settings');
                const today = ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'][now.getDay()];
                const workHours = settings.workHours[today] || { masuk: '08:00', pulang: '16:00' };

                const [masukHour, masukMinute] = workHours.masuk.split(':').map(Number);
                const [pulangHour, pulangMinute] = workHours.pulang.split(':').map(Number);
                
                const masukTime = new Date();
                masukTime.setHours(masukHour, masukMinute, 0, 0);
                
                const pulangTime = new Date();
                pulangTime.setHours(pulangHour, pulangMinute, 0, 0);

                if (now < masukTime) {
                    const diff = masukTime - now;
                    const minutes = Math.floor(diff / 60000);
                    countdownEl.textContent = `Presensi masuk: ${minutes} menit lagi`;
                    countdownEl.className = 'countdown early';
                } else if (now >= masukTime && now < pulangTime) {
                    const diff = pulangTime - now;
                    const hours = Math.floor(diff / 3600000);
                    const minutes = Math.floor((diff % 3600000) / 60000);
                    countdownEl.textContent = `Presensi pulang: ${hours}j ${minutes}m lagi`;
                    countdownEl.className = 'countdown going-home';
                } else {
                    countdownEl.textContent = `Waktu presensi telah berakhir`;
                    countdownEl.className = 'countdown late';
                }
            }

            setupEventListeners() {
                // Login Form
                document.getElementById('loginForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const username = document.getElementById('username').value;
                    const password = document.getElementById('password').value;
                    
                    if (await this.login(username, password)) {
                        alert('Login berhasil!');
                    } else {
                        alert('Username atau password salah!');
                    }
                });

                // Logout
                document.querySelector('.logout-btn').addEventListener('click', () => {
                    if (confirm('Apakah Anda yakin ingin logout?')) {
                        this.logout();
                    }
                });

                // Presensi Buttons
                document.getElementById('presensiMasukBtn').addEventListener('click', () => {
                    this.startPresensi('masuk');
                });

                document.getElementById('presensiPulangBtn').addEventListener('click', () => {
                    this.startPresensi('pulang');
                });

                // Capture Button
                document.getElementById('captureBtn').addEventListener('click', () => {
                    this.capturePresensi();
                });

                // WFH
                document.getElementById('ajukanWFHBtn').addEventListener('click', () => {
                    showModal('wfhModal');
                    document.getElementById('wfhDate').value = new Date().toISOString().split('T')[0];
                });

                document.getElementById('wfhForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = {
                        date: document.getElementById('wfhDate').value,
                        reason: document.getElementById('wfhReason').value,
                        detail: document.getElementById('wfhDetail').value
                    };
                    this.ajukanWFH(formData);
                    closeModal('wfhModal');
                });

                // Profile
                document.getElementById('profileForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const profileData = {
                        nama: document.getElementById('profileNama').value
                    };
                    
                    const newPassword = document.getElementById('profilePassword').value;
                    if (newPassword) {
                        profileData.password = newPassword;
                    }
                    
                    if (this.updateProfile(profileData)) {
                        document.getElementById('profilePassword').value = '';
                    }
                });

                // Admin Functions
                document.getElementById('addUserBtn').addEventListener('click', () => {
                    showModal('addUserModal');
                });

                document.getElementById('addUserForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const userData = {
                        nama: document.getElementById('newUserName').value,
                        username: document.getElementById('newUserUsername').value,
                        password: document.getElementById('newUserPassword').value,
                        role: document.getElementById('newUserRole').value
                    };
                    if (this.addUser(userData)) {
                        closeModal('addUserModal');
                        document.getElementById('addUserForm').reset();
                    }
                });

                // Reports
                document.getElementById('generatePDFBtn').addEventListener('click', () => {
                    this.generatePDF();
                });

                document.getElementById('generateJPEGBtn').addEventListener('click', () => {
                    this.generateJPEG();
                });

                // Navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const targetTab = item.getAttribute('data-tab');
                        
                        document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                        item.classList.add('active');
                        
                        document.querySelectorAll('.tab-content').forEach(content => {
                            content.classList.remove('active');
                            if (content.id === targetTab) {
                                content.classList.add('active');
                            }
                        });

                        // Reload data if needed
                        if (targetTab === 'history') {
                            this.updateHistoryList();
                        } else if (targetTab === 'admin' && this.currentUser.role === 'admin') {
                            this.loadAdminData();
                        }
                    });
                });
            }
        }

        // GLOBAL FUNCTIONS
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            // Stop camera when modal closes
            app.camera.stopCamera();
        }

        // Initialize application
        const app = new SIPDAApp();

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                closeModal(e.target.id);
            }
        });
    </script>
</body>
</html>